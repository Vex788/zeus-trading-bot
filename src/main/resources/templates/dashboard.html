<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="layout :: layout(~{::title}, ~{::content}, ~{::scripts})">
<head>
    <title>Dashboard - Crypto Trading Bot</title>
</head>
<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Dashboard</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-trading" id="startBtn" onclick="startBot()">
                        <i class="fas fa-play me-1"></i>Start
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="pauseBtn" onclick="pauseBot()">
                        <i class="fas fa-pause me-1"></i>Pause
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="stopBtn" onclick="stopBot()">
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                </div>
            </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Total Balance</div>
                                <div class="h5 mb-0 font-weight-bold" id="totalBalance">$100.00</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-wallet fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card" id="profitLossCard">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Profit/Loss</div>
                                <div class="h5 mb-0 font-weight-bold" id="profitLoss">$0.00</div>
                                <div class="small" id="profitLossPercent">0.00%</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">24h Trades</div>
                                <div class="h5 mb-0 font-weight-bold" id="tradesCount">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exchange-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-uppercase mb-1">ML Accuracy</div>
                                <div class="h5 mb-0 font-weight-bold" id="mlAccuracy">75.0%</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-brain fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Portfolio Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Trading Pairs</h5>
                    </div>
                    <div class="card-body">
                        <div id="tradingPairs">
                            <!-- Trading pairs will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Row -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Recent Trades</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Pair</th>
                                        <th>Action</th>
                                        <th>Amount</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTrades">
                                    <!-- Recent trades will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ML Predictions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Pair</th>
                                        <th>Direction</th>
                                        <th>Confidence</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="mlPredictions">
                                    <!-- ML predictions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:fragment="scripts">
        <script>
            let portfolioChart = null;
            
            // Initialize dashboard
            $(document).ready(function() {
                initializePortfolioChart();
                loadDashboardData();
                
                // Refresh data every 30 seconds
                setInterval(loadDashboardData, 30000);
            });
            
            function initializePortfolioChart() {
                const ctx = document.getElementById('portfolioChart').getContext('2d');
                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Portfolio Value',
                            data: [],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function loadDashboardData() {
                // Load overview data
                $.get('/api/dashboard/overview')
                    .done(function(data) {
                        updateOverviewMetrics(data);
                    })
                    .fail(function() {
                        console.error('Failed to load dashboard overview');
                    });
                
                // Load trading history for chart
                $.get('/api/dashboard/chart/profit-loss?hours=24')
                    .done(function(data) {
                        updatePortfolioChart(data.chartData);
                    })
                    .fail(function() {
                        console.error('Failed to load chart data');
                    });
                
                // Load recent trades
                $.get('/api/dashboard/trading-history?hours=24')
                    .done(function(data) {
                        updateRecentTrades(data.trades);
                    })
                    .fail(function() {
                        console.error('Failed to load recent trades');
                    });
                
                // Load ML predictions
                $.get('/api/dashboard/ml/predictions?limit=5')
                    .done(function(data) {
                        updateMLPredictions(data);
                    })
                    .fail(function() {
                        console.error('Failed to load ML predictions');
                    });
                
                // Load market data for trading pairs
                $.get('/api/dashboard/market-data')
                    .done(function(data) {
                        updateTradingPairs(data.marketData);
                    })
                    .fail(function() {
                        console.error('Failed to load market data');
                    });
            }
            
            function updateOverviewMetrics(data) {
                $('#totalBalance').text(formatCurrency(parseFloat(data.totalValue)));
                
                const profitLoss = parseFloat(data.profitLoss);
                const profitLossPercent = parseFloat(data.profitLossPercent);
                
                $('#profitLoss').text(formatCurrency(profitLoss));
                $('#profitLossPercent').text(formatPercent(profitLossPercent));
                
                // Update profit/loss card color
                const card = $('#profitLossCard');
                card.removeClass('positive negative');
                if (profitLoss > 0) {
                    card.addClass('positive');
                } else if (profitLoss < 0) {
                    card.addClass('negative');
                }
                
                $('#tradesCount').text(data.recentTradesCount);
                $('#mlAccuracy').text(parseFloat(data.mlAccuracy).toFixed(1) + '%');
            }
            
            function updatePortfolioChart(chartData) {
                if (!portfolioChart) return;
                
                const labels = Object.keys(chartData);
                const values = Object.values(chartData).map(v => parseFloat(v));
                
                // Calculate cumulative values
                let cumulative = 100; // Starting balance
                const cumulativeValues = values.map(v => {
                    cumulative += v;
                    return cumulative;
                });
                
                portfolioChart.data.labels = labels.map(label => new Date(label).toLocaleTimeString());
                portfolioChart.data.datasets[0].data = cumulativeValues;
                portfolioChart.update();
            }
            
            function updateRecentTrades(trades) {
                const tbody = $('#recentTrades');
                tbody.empty();
                
                trades.slice(0, 5).forEach(trade => {
                    const row = $(`
                        <tr>
                            <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
                            <td><span class="badge trading-pair-badge">${trade.tradingPair}</span></td>
                            <td><span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.action}</span></td>
                            <td>${parseFloat(trade.amount).toFixed(6)}</td>
                            <td>$${parseFloat(trade.price).toFixed(2)}</td>
                        </tr>
                    `);
                    tbody.append(row);
                });
                
                if (trades.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center text-muted">No recent trades</td></tr>');
                }
            }
            
            function updateMLPredictions(predictions) {
                const tbody = $('#mlPredictions');
                tbody.empty();
                
                predictions.forEach(prediction => {
                    const direction = prediction.direction;
                    const confidence = parseFloat(prediction.confidence) * 100;
                    
                    const row = $(`
                        <tr>
                            <td><span class="badge trading-pair-badge">${prediction.tradingPair}</span></td>
                            <td><span class="badge ${direction === 'UP' ? 'bg-success' : 'bg-danger'}">${direction}</span></td>
                            <td>${confidence.toFixed(1)}%</td>
                            <td>${new Date(prediction.timestamp).toLocaleTimeString()}</td>
                        </tr>
                    `);
                    tbody.append(row);
                });
                
                if (predictions.length === 0) {
                    tbody.append('<tr><td colspan="4" class="text-center text-muted">No recent predictions</td></tr>');
                }
            }
            
            function updateTradingPairs(marketData) {
                const container = $('#tradingPairs');
                container.empty();
                
                Object.entries(marketData).forEach(([pair, data]) => {
                    const price = parseFloat(data.lastPrice);
                    const volume = parseFloat(data.volume);
                    
                    const pairCard = $(`
                        <div class="mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${pair}</h6>
                                    <small class="text-muted">Vol: ${volume.toFixed(2)}</small>
                                </div>
                                <div class="text-end">
                                    <div class="h6 mb-0">$${price.toFixed(2)}</div>
                                    <small class="text-muted">${new Date(data.timestamp).toLocaleTimeString()}</small>
                                </div>
                            </div>
                        </div>
                    `);
                    container.append(pairCard);
                });
                
                if (Object.keys(marketData).length === 0) {
                    container.append('<p class="text-center text-muted">No market data available</p>');
                }
            }
            
            // Bot control functions
            function startBot() {
                const btn = $('#startBtn');
                showLoading(btn[0]);
                
                $.post('/api/trading/start')
                    .done(function(response) {
                        if (response.success) {
                            showToast('Trading bot started successfully', 'success');
                        } else {
                            showToast(response.message, 'warning');
                        }
                    })
                    .fail(function() {
                        showToast('Failed to start trading bot', 'danger');
                    })
                    .always(function() {
                        hideLoading(btn[0]);
                    });
            }
            
            function pauseBot() {
                const btn = $('#pauseBtn');
                showLoading(btn[0]);
                
                $.post('/api/trading/pause')
                    .done(function(response) {
                        if (response.success) {
                            showToast('Trading bot paused successfully', 'success');
                        } else {
                            showToast(response.message, 'warning');
                        }
                    })
                    .fail(function() {
                        showToast('Failed to pause trading bot', 'danger');
                    })
                    .always(function() {
                        hideLoading(btn[0]);
                    });
            }
            
            function stopBot() {
                const btn = $('#stopBtn');
                showLoading(btn[0]);
                
                $.post('/api/trading/stop')
                    .done(function(response) {
                        if (response.success) {
                            showToast('Trading bot stopped successfully', 'success');
                        } else {
                            showToast(response.message, 'warning');
                        }
                    })
                    .fail(function() {
                        showToast('Failed to stop trading bot', 'danger');
                    })
                    .always(function() {
                        hideLoading(btn[0]);
                    });
            }
            
            // WebSocket update handlers
            function updatePortfolioDisplay(portfolio) {
                if (portfolio.balance) {
                    $('#totalBalance').text(formatCurrency(parseFloat(portfolio.balance)));
                }
                if (portfolio.profitLoss) {
                    const profitLoss = parseFloat(portfolio.profitLoss);
                    $('#profitLoss').text(formatCurrency(profitLoss));
                    
                    const card = $('#profitLossCard');
                    card.removeClass('positive negative');
                    if (profitLoss > 0) {
                        card.addClass('positive');
                    } else if (profitLoss < 0) {
                        card.addClass('negative');
                    }
                }
                if (portfolio.profitLossPercent) {
                    $('#profitLossPercent').text(formatPercent(parseFloat(portfolio.profitLossPercent)));
                }
            }
            
            function updateMarketDataDisplay(marketData) {
                updateTradingPairs(marketData);
            }
        </script>
    </div>
</body>
</html>